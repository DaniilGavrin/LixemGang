name: Deploy Flutter Web

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: üì• Checkout
      uses: actions/checkout@v4

    - name: üê¶ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.5'
        channel: 'stable'

    - name: üåê Build Web
      run: flutter build web --release

    - name: üîë Setup SSH (for cleanup & reload)
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        password: ${{ secrets.DEPLOY_PASSWORD }}
        script: |
          # –û—á–∏—Å—Ç–∏—Ç—å –°–û–î–ï–†–ñ–ò–ú–û–ï –ø–∞–ø–∫–∏, –Ω–æ –Ω–µ —Å–∞–º—É –ø–∞–ø–∫—É
          rm -rf /var/www/lixemgang/*
          # –ò–ª–∏, –µ—Å–ª–∏ –µ—Å—Ç—å —Å–∫—Ä—ã—Ç—ã–µ —Ñ–∞–π–ª—ã (—Ä–µ–¥–∫–æ –¥–ª—è Flutter):
          # rm -rf /var/www/lixemgang/{*,.*}
          # –ù–æ –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ —Å .* ‚Äî –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å .well-known!

    - name: üöÄ Deploy with rsync
      uses: burnett01/rsync-deployments@v2.2
      with:
            switches: -av --delete
            path: build/web/
            remote_path: /var/www/lixemgang/
            remote_host: ${{ secrets.DEPLOY_HOST }}
            remote_user: ${{ secrets.DEPLOY_USER }}
            remote_password: ${{ secrets.DEPLOY_PASSWORD }}

    - name: ‚úÖ Reload nginx
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        password: ${{ secrets.DEPLOY_PASSWORD }}
        script: sudo systemctl reload nginx